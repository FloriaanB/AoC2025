LIBRARY ieee;
USE ieee.std_logic_1164.ALL;
USE ieee.numeric_std.ALL;

ENTITY part1 IS
  PORT (
    clk : IN STD_LOGIC;
    rst : IN STD_LOGIC;
    value : IN signed(15 DOWNTO 0);
    direction : IN STD_LOGIC;
    valid : IN STD_LOGIC;
    code : OUT signed(15 DOWNTO 0);
    done : OUT STD_LOGIC
  );
END part1;

ARCHITECTURE rtl OF part1 IS

  SIGNAL score : signed(15 DOWNTO 0);
  SIGNAL valid_d : STD_LOGIC;

BEGIN

  PROCESS (clk, rst)
    VARIABLE score_v : signed(15 DOWNTO 0);
    VARIABLE value_v : signed(15 DOWNTO 0);
  BEGIN
    IF rst = '1' THEN
      code <= (OTHERS => '0');
      score <= to_signed(50, 16);
      valid_d <= '0';
      done <= '0';
    ELSIF rising_edge(clk) THEN
      IF valid = '1' THEN
        value_v := value MOD 100;
        -- REPORT to_string(to_integer(score_v));value_v

        IF direction = '1' THEN
          score_v := score + value_v;
        ELSE
          score_v := score - value_v;
        END IF;
      END IF;

      IF score_v < 0 THEN
        score <= 100 + score_v;
      ELSIF score_v >= 100 THEN
        score <= score_v - 100;
      ELSE
        score <= score_v;
      END IF;

      IF score = 0 THEN
        code <= code + 1;
      END IF;
      -- score <= score_v;

      valid_d <= valid;

      done <= valid_d AND NOT valid;

    END IF;
  END PROCESS;

END ARCHITECTURE;